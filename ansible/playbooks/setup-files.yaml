- name: Copy and generate files
  hosts: inception_hosts

  tasks:
    - name: Copy config files to remote servers
      ansible.builtin.copy:
        src: ../../inception/srcs/
        dest: ~/inception
        mode: '0644'

    - name: Create .env from example.env
      ansible.builtin.copy:
        src: "~/inception/example.env"
        dest: "~/inception/.env"
        remote_src: true
        force: false
        mode: '0644'

    - name: Generate dynamic Nginx configuration
      ansible.builtin.template:
        src: "../../inception/srcs/requirements/nginx/conf/nginx.conf.j2"
        dest: "~/inception/requirements/nginx/conf/nginx.conf"
        mode: '0644'

    - name: Generate dynamic wordpress script
      ansible.builtin.template:
        src: "../../inception/srcs/requirements/wordpress/tools/setup.sh.j2"
        dest: "~/inception/requirements/wordpress/tools/setup.sh"
        mode: '0644'

    - name: Install certbot
      become: true
      ansible.builtin.package:
        name: certbot
        state: present
        update_cache: yes

    - name: Obtain Let's Encrypt certificate
      become: true
      ansible.builtin.command:
        cmd: >
          certbot certonly --standalone
          -d {{ domain }}
          --non-interactive
          --agree-tos
          --register-unsafely-without-email
          --keep-until-expiring
      register: certbot_result
      changed_when: "'Certificate not yet due for renewal' not in certbot_result.stdout"

    - name: Make Let's Encrypt certs readable
      become: true
      ansible.builtin.command:
        cmd: chmod -R a+rX /etc/letsencrypt/live /etc/letsencrypt/archive

    - name: Copy Let's Encrypt certificate
      ansible.builtin.copy:
        src: "/etc/letsencrypt/live/{{ domain }}/fullchain.pem"
        dest: "~/inception/requirements/nginx/conf/nginx.crt"
        remote_src: true
        mode: '0644'

    - name: Copy Let's Encrypt private key
      ansible.builtin.copy:
        src: "/etc/letsencrypt/live/{{ domain }}/privkey.pem"
        dest: "~/inception/requirements/nginx/conf/nginx.key"
        remote_src: true
        mode: '0600'
